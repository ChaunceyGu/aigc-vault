# 安全说明

本文档说明系统的安全配置和最佳实践。

## 目录

- [用户认证与权限控制](#用户认证与权限控制)
- [NSFW 内容管理](#nsfw-内容管理)
- [外网访问配置](#外网访问配置)
- [数据安全](#数据安全)
- [安全建议](#安全建议)

## 用户认证与权限控制

### JWT 认证

系统采用 JWT（JSON Web Token）进行用户认证：

1. **用户注册与登录**：
   - 用户可以通过注册页面创建账号
   - 登录后获得 JWT token，存储在 localStorage
   - Token 默认有效期为 24 小时（可通过 `JWT_ACCESS_TOKEN_EXPIRE_MINUTES` 配置）

2. **Token 安全**：
   - Token 使用 HS256 算法签名
   - 密钥通过 `JWT_SECRET_KEY` 环境变量配置
   - ⚠️ **生产环境必须使用强随机密钥**

### 验证码系统

系统在登录和注册时都使用验证码来防止暴力破解：

1. **验证码类型**：
   - **简单（40%）**：两位数加减法（10-99）
     - 例如：`45 + 23 = ?` 或 `78 - 34 = ?`
   - **中等（40%）**：乘法或三位数加减
     - 乘法：`7 × 8 = ?`（2-12 的乘法表）
     - 三位数加减：`456 + 78 = ?` 或 `789 - 123 = ?`
   - **困难（20%）**：混合运算或大数运算
     - 混合运算：`15 + 3 × 4 = ?` 或 `6 × 7 - 12 = ?`
     - 大数运算：`567 + 234 = ?` 或 `987 - 456 = ?`

2. **安全特性**：
   - 验证码 5 分钟过期
   - 验证后立即标记为已使用，防止重复使用
   - 自动清理过期验证码
   - 支持负数答案（混合运算可能产生负数）

3. **API 接口**：
   - `GET /api/auth/captcha`：获取验证码
   - 登录和注册接口都需要提供验证码 ID 和答案

4. **使用建议**：
   - 验证码错误时会自动刷新，用户无需手动操作
   - 如果验证码过期，需要刷新获取新的验证码
   - 生产环境建议使用 Redis 存储验证码，提高性能和可扩展性

### RBAC 权限系统

系统使用 RBAC（基于角色的访问控制）进行权限管理：

1. **角色**：
   - 系统预设三个角色（admin、editor、user），支持创建自定义角色
   - 角色可以动态创建、编辑、删除

2. **权限**：
   - 细粒度权限控制，如 `log.create`、`log.edit`、`user.manage` 等
   - 权限列表显示中文名称，更易理解

3. **权限分配**：
   - 通过角色分配权限，用户通过角色获得权限
   - 一个用户可以有多个角色

4. **默认权限**：
   - `admin`：拥有所有权限
   - `editor`：可以创建和编辑记录
   - `user`：只能查看和收藏

### 默认管理员账号

- 首次部署时自动创建默认管理员账号
- 默认用户名：`admin`，默认密码：`admin123456`
- ⚠️ **首次登录后请立即修改密码！**
- 可以通过环境变量 `DEFAULT_ADMIN_USERNAME` 和 `DEFAULT_ADMIN_PASSWORD` 自定义

## NSFW 内容管理

### 功能说明

- 创建记录时可以标记为 NSFW 内容
- NSFW 图片会自动打码（模糊处理），简洁的水印提示
- 详情页可以切换显示/隐藏 NSFW 内容
- 下载时会自动获取原始图片（未打码版本）
- 统一的灯箱预览体验，支持点击遮罩层关闭

### 使用建议

- 标记所有可能包含敏感内容的图片
- 定期审查 NSFW 标记的准确性
- 根据实际需求调整打码强度

## 外网访问配置

### 安全部署原则

系统支持通过 API 代理访问所有资源，无需暴露内部端口：

**默认安全配置**：
1. **数据库**：不暴露端口，仅在 Docker 内部网络可访问（`docker-compose.yml` 中 `postgres` 服务的 `ports` 已注释）
2. **后端 API**：不暴露端口，通过 Nginx 代理访问
3. **文件存储**：配置 `RUSTFS_ENDPOINT_URL` 为内部IP，通过 API 代理访问
4. **Web 服务**：仅暴露 80 端口，所有请求通过 Nginx 代理

### 文件访问代理

- 图片显示：`/api/assets/{file_key}/stream`
- 文件下载：`/api/assets/{file_key}/download`
- 所有文件访问都通过后端 API 代理，无需暴露 RustFS 端口

### 优势

- ✅ 更安全：数据库和内部服务不暴露到外网
- ✅ 更灵活：可以通过 Nginx 配置 HTTPS、访问控制等
- ✅ 更简单：只需暴露一个 Web 端口（80/443）

### 如果需要从外部访问数据库

- 编辑 `docker-compose.yml`，取消 `postgres` 服务的 `ports` 注释
- ⚠️ **注意**：暴露数据库端口会带来安全风险，建议仅在开发环境使用

## 数据安全

### 密码安全

- 使用 bcrypt 进行密码哈希
- 密码不会以明文形式存储
- 建议使用强密码策略

### 数据库安全

- 使用强密码
- 限制数据库访问 IP（如果使用外部数据库）
- Docker 部署时默认不暴露数据库端口
- 定期备份数据库

### 文件存储安全

- 使用 Access Key 和 Secret Key 进行认证
- 限制 Access Key 的权限范围（最小权限原则）
- 生产环境建议使用 HTTPS

### 数据传输安全

- 生产环境建议使用 HTTPS
- 配置 Nginx SSL/TLS
- 使用安全的 CORS 配置

## 安全建议

### 生产环境检查清单

- [ ] 修改 `JWT_SECRET_KEY` 为强随机字符串
- [ ] 修改默认管理员密码
- [ ] 配置 HTTPS
- [ ] 限制 CORS 源
- [ ] 数据库不暴露端口
- [ ] 使用强密码
- [ ] 定期更新依赖包
- [ ] 启用日志记录
- [ ] 定期备份数据
- [ ] 监控系统日志

### 密钥管理

- ⚠️ **不要将密钥提交到 Git**
- 使用环境变量或密钥管理服务
- 定期轮换密钥
- 使用不同的密钥用于不同环境

### 依赖安全

- 定期更新依赖包
- 使用 `npm audit` 和 `pip-audit` 检查漏洞
- 关注安全公告

### 日志和监控

- 启用日志记录
- 监控异常访问
- 定期审查日志
- 设置告警机制

## 相关文档

- [安装部署](./INSTALLATION.md)
- [配置说明](./CONFIGURATION.md)
- [开发指南](./DEVELOPMENT.md)

