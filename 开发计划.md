# AI 绘图资产归档系统 - 开发计划

基于 PRD V2.0 制定的详细开发计划。

---

## 项目概览

| 属性 | 内容 |
| :--- | :--- |
| **项目名称** | AI 绘图资产归档系统 (AIGC Asset Vault) |
| **开发周期** | 预计 4-6 周（单人开发） |
| **技术架构** | 前端 + 后端 + Postgres + RustFS |

---

## 阶段一：项目初始化与环境搭建（3-5天）

### 1.1 技术栈确定
- [ ] **前端**: React + TypeScript + Vite + Ant Design (或 Tailwind CSS)
- [ ] **后端**: Python FastAPI (推荐，图片处理便捷) / Go Gin / Node.js
- [ ] **数据库**: PostgreSQL (确保支持数组和GIN索引)
- [ ] **文件存储**: RustFS (需要先验证API接口)

### 1.2 项目结构初始化
```
项目根目录/
├── frontend/          # 前端项目
│   ├── src/
│   │   ├── components/
│   │   ├── pages/
│   │   ├── services/
│   │   ├── hooks/
│   │   └── utils/
│   └── package.json
├── backend/           # 后端项目
│   ├── app/
│   │   ├── api/
│   │   ├── models/
│   │   ├── services/
│   │   ├── utils/
│   │   └── main.py
│   └── requirements.txt
├── migrations/        # 数据库迁移脚本
│   └── init.sql
├── docs/             # 文档
└── docker-compose.yml # 本地开发环境（可选）
```

### 1.3 开发环境配置
- [ ] 配置 Node.js 和 Python 环境
- [ ] 初始化 Git 仓库
- [ ] 配置代码格式化和 Lint 工具（ESLint, Black/ruff）
- [ ] 设置 `.gitignore`

### 1.4 RustFS 接口验证（关键）
- [ ] 确认 RustFS API 文档
- [ ] 验证文件上传接口（如何获取 file_key）
- [ ] 验证文件下载/访问接口
- [ ] 编写 RustFS 客户端封装（如果使用 Python，考虑 requests 库）

---

## 阶段二：数据库设计与建表（1-2天）

### 2.1 执行 SQL 建表
- [ ] 创建 `gen_logs` 表
- [ ] 创建 `log_assets` 表
- [ ] 创建索引（GIN 索引用于数组查询）

### 2.2 数据库迁移脚本
- [ ] 编写 `migrations/init.sql`
- [ ] 编写数据库连接工具类
- [ ] 测试数据库连接和查询

### 2.3 初始化测试数据
- [ ] 插入少量测试数据
- [ ] 验证数组查询性能（如：`WHERE 'SDXL' = ANY(models)`）

---

## 阶段三：后端基础架构（5-7天）

### 3.1 后端框架搭建
- [ ] 初始化 FastAPI 项目
- [ ] 配置 CORS、中间件
- [ ] 设置环境变量管理（.env）
- [ ] 配置日志系统

### 3.2 RustFS 集成模块
- [ ] 封装 RustFS 客户端（上传、下载、删除）
- [ ] 实现错误处理和重试机制
- [ ] 编写单元测试

### 3.3 数据库 ORM/查询层
- [ ] 选择 ORM（SQLAlchemy / SQLModel 或原生 SQL）
- [ ] 定义数据模型（对应 `gen_logs` 和 `log_assets`）
- [ ] 实现基础 CRUD 操作

### 3.4 图片处理模块
- [ ] 安装图片处理库（Pillow / PIL）
- [ ] 实现缩略图生成函数（300px JPG）
- [ ] 实现图片格式验证和压缩
- [ ] 编写单元测试

---

## 阶段四：模块一 - 新建记录功能（7-10天）

### 4.1 后端 API 开发
- [ ] **POST /api/logs** - 创建记录接口
  - 接收表单数据（JSON）
  - 接收文件流（multipart/form-data）
  - 生成缩略图
  - 上传原图和缩略图到 RustFS
  - 写入数据库（事务处理）
- [ ] **GET /api/tags/tools** - 获取所有工具标签
- [ ] **GET /api/tags/models** - 获取所有模型标签

### 4.2 前端页面开发 - 新建记录页
- [ ] 创建表单组件
  - 标题输入框（必填）
  - 类型单选按钮（txt2img / img2img）
  - 工具标签输入框（支持回车添加、删除）
  - 模型标签输入框
  - Prompt 多行文本框
  - Params 多行文本框
- [ ] 实现标签输入组件
  - 本地缓存（LocalStorage）记录最近使用标签
  - 自动补全提示
- [ ] 实现文件上传组件
  - 拖拽上传功能
  - 图片预览（缩略图）
  - 根据类型显示不同上传区：
    - **txt2img**: 仅输出区
    - **img2img**: 输入区（带 Note 输入框）+ 输出区
- [ ] 表单验证和提交
  - 前端验证
  - 调用后端 API
  - 成功/失败提示
  - 跳转到详情页

### 4.3 联调与测试
- [ ] 测试完整上传流程
- [ ] 验证缩略图生成质量
- [ ] 验证数据库存储正确性
- [ ] 修复边界情况（大文件、格式错误等）

---

## 阶段五：模块二 - 资产图库（5-7天）

### 5.1 后端 API 开发
- [ ] **GET /api/logs** - 列表查询接口
  - 支持分页（page, page_size）
  - 支持标题搜索（LIKE 查询）
  - 支持标签过滤（数组包含查询）
  - 支持类型过滤
  - 返回封面缩略图 URL（第一张 output 图片）
- [ ] **GET /api/tags/stats** - 获取标签统计（用于过滤器）

### 5.2 前端页面开发 - 图库页
- [ ] 搜索和筛选组件
  - 搜索框（标题搜索）
  - 标签过滤器（列出所有工具/模型标签，可多选）
- [ ] 列表展示组件
  - 瀑布流或卡片网格布局（建议使用 react-masonry-css 或类似库）
  - 卡片组件：
    - 封面图（缩略图，懒加载）
    - 标题
    - 标签展示（前 3 个）
    - img2img 角标图标
- [ ] 分页或无限滚动
- [ ] 点击卡片跳转到详情页

### 5.3 性能优化
- [ ] 图片懒加载
- [ ] 列表分页加载
- [ ] 缓存标签统计数据

---

## 阶段六：模块三 - 详情浏览（5-7天）

### 6.1 后端 API 开发
- [ ] **GET /api/logs/{id}** - 获取单条记录详情
  - 返回完整元数据
  - 返回关联的 assets（按 sort_order 排序）
  - 区分 input 和 output 类型
- [ ] **GET /api/assets/{file_key}** - 获取原图（用于灯箱模式）

### 6.2 前端页面开发 - 详情页
- [ ] 左侧元数据面板
  - 标题展示
  - 标签组展示
  - Prompt 区域（带 Copy 按钮）
  - Params 区域（带 Copy 按钮）
- [ ] 右侧画廊面板
  - 输入素材区（仅 img2img 显示）
    - 标题："原始参考"
    - 图片网格
    - 每张图片下方显示 Note
  - 生成结果区
    - 标题："生成样张"
    - 图片网格
- [ ] 灯箱模式组件
  - 点击图片弹出全屏查看器
  - 支持左右切换（键盘或按钮）
  - 加载原图（从 RustFS）
  - ESC 键关闭

### 6.3 交互优化
- [ ] 添加加载状态
- [ ] 添加错误处理（图片加载失败）
- [ ] 优化移动端响应式布局

---

## 阶段七：测试与优化（5-7天）

### 7.1 功能测试
- [ ] 端到端测试所有核心流程
- [ ] 边界情况测试（空数据、大文件、特殊字符等）
- [ ] 浏览器兼容性测试

### 7.2 性能优化
- [ ] 后端 API 性能优化（数据库查询优化、缓存）
- [ ] 前端性能优化（代码分割、图片压缩、CDN）
- [ ] 缩略图生成性能优化（批量处理、异步）

### 7.3 用户体验优化
- [ ] UI/UX 细节优化
- [ ] 加载动画和过渡效果
- [ ] 错误提示优化
- [ ] 响应式布局优化

### 7.4 代码质量
- [ ] 代码审查
- [ ] 添加注释和文档
- [ ] 清理冗余代码

---

## 阶段八：部署与上线（3-5天）

### 8.1 生产环境配置
- [ ] 配置生产环境变量
- [ ] 配置数据库连接池
- [ ] 配置静态资源服务（Nginx 或 CDN）
- [ ] 配置 HTTPS

### 8.2 部署脚本
- [ ] 编写 Dockerfile（可选）
- [ ] 编写部署脚本
- [ ] 配置 CI/CD（可选）

### 8.3 文档编写
- [ ] API 文档（使用 FastAPI 自动生成或 Swagger）
- [ ] 用户使用手册
- [ ] 部署文档
- [ ] 运维文档

### 8.4 上线前检查
- [ ] 数据库备份策略
- [ ] 监控和日志配置
- [ ] 性能压测（可选）

---

## 关键风险与应对

### 风险 1: RustFS 接口不明确
- **应对**: 提前验证接口，如果接口不稳定，考虑先实现本地文件存储作为备选方案

### 风险 2: 图片处理性能瓶颈
- **应对**: 考虑异步任务队列（Celery / RQ）处理大文件缩略图生成

### 风险 3: 前端大图加载慢
- **应对**: 严格使用缩略图，原图仅在灯箱模式加载，添加加载进度提示

### 风险 4: 数据库数组查询性能
- **应对**: 确保 GIN 索引正确创建，监控慢查询

---

## 开发优先级建议

**MVP（最小可用产品）优先顺序：**
1. ✅ 数据库建表
2. ✅ 后端基础架构 + 图片上传
3. ✅ 新建记录功能（txt2img 模式）
4. ✅ 简单的列表展示
5. ✅ 详情页基础功能
6. 完善筛选搜索
7. img2img 模式完整支持
8. 灯箱模式
9. 性能优化

**快速验证方案：**
如果时间紧迫，可以先实现 txt2img 模式的完整流程，img2img 和高级功能后续迭代。

---

## 后续迭代计划（V2.1+）

- [ ] 批量导入功能（从现有文件夹批量导入）
- [ ] 标签管理（合并、重命名标签）
- [ ] 高级搜索（日期范围、多标签组合）
- [ ] 导出功能（导出 Prompt、导出图片）
- [ ] 收藏/收藏夹功能
- [ ] 图片编辑功能（裁剪、标注）
- [ ] 统计面板（最常用模型、标签云）

---

**计划制定日期**: 2025-12-09  
**预计完成日期**: 根据开发进度动态调整

