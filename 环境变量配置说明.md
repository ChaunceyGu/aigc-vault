# 环境变量配置说明

## 📋 后端环境变量 (.env)

在**项目根目录**创建 `.env` 文件，配置以下变量：

> 💡 **注意**：使用 Docker Compose 时，`.env` 文件应放在项目根目录（与 `docker-compose.yml` 同级）

### 数据库配置

```env
# PostgreSQL 数据库连接
# 格式: postgresql://用户名:密码@主机:端口/数据库名
DATABASE_URL=postgresql://aigc_user:your_password@localhost:5432/aigc_vault
```

**说明：**
- 开发环境：通常使用 `localhost`
- 生产环境：使用实际的数据库服务器地址
- 确保密码足够安全

### RustFS/S3 存储配置

```env
# S3 兼容的存储服务端点
RUSTFS_ENDPOINT_URL=http://192.168.31.3:9900

# 访问密钥
RUSTFS_ACCESS_KEY=your_access_key
RUSTFS_SECRET_KEY=your_secret_key

# 存储桶名称
RUSTFS_BUCKET=aigcvault

# 区域（S3 兼容服务通常可以是任意值）
RUSTFS_REGION=us-east-1

# 是否使用 SSL/TLS
RUSTFS_USE_SSL=false
```

**说明：**
- `RUSTFS_ENDPOINT_URL`: 存储服务的 HTTP/HTTPS 地址
- `RUSTFS_USE_SSL`: 
  - `false`: 使用 HTTP（内网环境）
  - `true`: 使用 HTTPS（生产环境推荐）

### CORS 配置

```env
# 允许跨域的前端地址（逗号分隔）
CORS_ORIGINS=http://localhost:5173,http://localhost:3000,https://yourdomain.com
```

**说明：**
- 开发环境：通常包含 `http://localhost:5173`（Vite 默认端口）
- 生产环境：仅包含实际的前端域名
- 支持多个域名，用逗号分隔

### 日志配置（可选）

```env
# 日志级别: DEBUG, INFO, WARNING, ERROR
LOG_LEVEL=INFO
```

---

## 🔒 安全注意事项

### 1. 不要提交 .env 文件到 Git

确保 `.env` 在 `.gitignore` 中：

```gitignore
# .env 文件
backend/.env
.env
```

### 2. 生产环境配置

**开发环境示例：**
```env
DATABASE_URL=postgresql://user:password@localhost:5432/aigc_vault_dev
RUSTFS_ENDPOINT_URL=http://localhost:9000
CORS_ORIGINS=http://localhost:5173
```

**生产环境示例：**
```env
DATABASE_URL=postgresql://prod_user:secure_password_123@db.example.com:5432/aigc_vault
RUSTFS_ENDPOINT_URL=https://storage.example.com
RUSTFS_USE_SSL=true
CORS_ORIGINS=https://yourdomain.com
```

### 3. 密钥管理

- ✅ 使用强密码（至少 16 位，包含大小写字母、数字、特殊字符）
- ✅ 定期更换密钥
- ✅ 使用环境变量管理器（如 Docker secrets、Kubernetes secrets）
- ✅ 不要硬编码在代码中

---

## 🔍 验证配置

### 1. 验证数据库连接

```bash
cd backend
source venv/bin/activate
python scripts/verify_db.py
```

### 2. 验证 RustFS/S3 连接

```bash
cd backend
source venv/bin/activate
python scripts/verify_rustfs.py
```

### 3. 验证环境变量加载

```bash
cd backend
source venv/bin/activate
python -c "from app.config import settings; print(settings.DATABASE_URL)"
```

---

## 📝 环境变量模板

在项目根目录创建 `.env` 文件：

```env
# ============================================
# 数据库配置
# ============================================
# PostgreSQL 数据库连接
# 格式: postgresql://用户名:密码@主机:端口/数据库名
# Docker Compose 中使用 postgres 服务名
DATABASE_URL=postgresql://postgres:postgres@postgres:5432/aigc_vault

# ============================================
# RustFS/S3 存储配置
# ============================================
# S3 兼容的存储服务端点
RUSTFS_ENDPOINT_URL=http://192.168.31.3:9900

# 访问密钥
RUSTFS_ACCESS_KEY=your_access_key
RUSTFS_SECRET_KEY=your_secret_key

# 存储桶名称
RUSTFS_BUCKET=aigcvault

# 区域（S3 兼容服务通常可以是任意值）
RUSTFS_REGION=us-east-1

# 是否使用 SSL/TLS
RUSTFS_USE_SSL=false

# ============================================
# CORS 配置
# ============================================
# 允许跨域的前端地址（逗号分隔）
CORS_ORIGINS=http://localhost,http://localhost:80

# ============================================
# 日志配置（可选）
# ============================================
# 日志级别: DEBUG, INFO, WARNING, ERROR
LOG_LEVEL=INFO
```

---

## 🚀 快速配置步骤（Docker Compose）

1. **在项目根目录创建 `.env` 文件**：
   ```bash
   # 在项目根目录（与 docker-compose.yml 同级）
   nano .env  # 或使用其他编辑器
   ```

2. **填写实际值**：
   - 修改数据库连接信息（如果使用外部数据库）
   - 修改 RustFS/S3 配置（必须）
   - 修改 CORS 配置（根据实际前端地址）

3. **启动服务**：
   ```bash
   docker-compose up -d
   ```

4. **验证配置**（可选）：
   ```bash
   # 进入后端容器验证
   docker exec -it aigc-backend python -c "from app.config import settings; print('DB:', settings.DATABASE_URL); print('S3:', settings.RUSTFS_ENDPOINT_URL)"
   ```

---

## 🐳 Docker Compose 配置说明

`docker-compose.yml` 会自动从 `.env` 文件读取环境变量：

```yaml
backend:
  env_file:
    - .env  # 从项目根目录的 .env 文件读取
```

**重要提示**：
- `.env` 文件必须放在项目根目录（与 `docker-compose.yml` 同级）
- 不要将 `.env` 文件提交到 Git（确保在 `.gitignore` 中）
- 生产环境建议使用 Docker secrets 或其他密钥管理方案

---

## ⚠️ 常见问题

### 问题 1: 数据库连接失败

**可能原因：**
- 数据库未启动
- 用户名/密码错误
- 数据库不存在

**解决方法：**
```bash
# 检查 PostgreSQL 状态
sudo systemctl status postgresql

# 检查数据库是否存在
sudo -u postgres psql -l
```

### 问题 2: RustFS/S3 连接失败

**可能原因：**
- 端点地址错误
- 访问密钥错误
- 存储桶不存在

**解决方法：**
```bash
# 测试连接
python scripts/verify_rustfs.py

# 检查网络连通性
curl http://your-endpoint-url:9900
```

### 问题 3: CORS 错误

**可能原因：**
- 前端地址未在 CORS_ORIGINS 中配置
- 协议不匹配（http vs https）

**解决方法：**
- 确保前端地址完整（包含协议和端口）
- 生产环境使用 HTTPS

---

**配置完成后，系统即可正常运行！** 🎉

